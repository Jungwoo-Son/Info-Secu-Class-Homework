# 네트워크

### OSI 7 계층
(1~2 계층 - 하드웨어, 3~4 계층 커널, 5~7 계층 유저)

1. 물리 계층

   기기 간의 데이터를 전송을 위한 물리적인 수단을 제공하는 계층이다.
   모뎀, 리피터, 허브 등이 여기에 속한다.

2. 데이터 링크 게층

   두 지점 간의 신뢰성 있는 전송을 보장하며 오류 제어와 흐름 제어를 한다.
   이더넷이 여기서 구현되며 MAC주소를 사용한다.
   스위치나 랜 카드가 여기에 속한다.

3. 네트워크 계층
   멀리 떨어져 여러 개의 지점을 거칠 때 경로를 찾는다.
   IP를 사용하며 ARP와 같은 프로토콜이 구현된다.
   라우터가 여기에 속한다.

4. 전송 계층
   사용자들이 송수신하는데 있어 데이터를 주고 받을 수 있게 한다.
   상위 계층이 데이터  전달의 유효성이나 효율성을 생각하지 않게 한다. 
   Port 번호를 사용하며 TCP, UDP 등이 구현된다.

5. 세션 계층
   프로세스가 통신을 관리하기 위한 방법을 제공한다.
   여러 동기화 혹은 TCP/IP의 세션 관리(다시 시작, 종류 등)을 관리한다.

6. 표현 계층
   데이터의 형식을 다루는 계층으로 ASCII로 인코딩된 데이터를 UTF-8로 바꾸는 등의 역할을 한다.

7. 응용 계층
   응용 프로그램에서 서비스를 수행한다.



아래의 장치들로 내부 네트워크가 만들어지고 라우터를 통해 네트워크들이 연결된다.

### 허브

허브는 물리 계층에 해당하는 장치 중 하나이다. 이는 연결된 모든 기기에게 데이터를 송수신한다.

### 스위치

스위치는 데이터 링크 계층에 속하는 장치 중 하나이다. 이는 허브와 비슷한 역할을 하나 연결된 기기중 1:1로 데이터를 송수신한다. 따라서 네트워크 충돌이 없고 더 빠른 통신이 가능하다. 각 기기들을 구별하기위해 MAC 주소를 사용한다.

### 라우터

2개 이상의 논리적인 네트워크를 연결한다. 데이터를 목표지로 전달하기 위해 최적의 경로를 찾고 그 경로를 따라 다음 장치로 전송한다. 이때 목표지로 IP 주소를 사용한다. 공유기는 라우터에 속한다.



### LAN

LAN은 자신이 포함된 같은 네트워크를 의미하고 비교적 작은 범위로 구성된다.
만약 하나의 스위치(라우터)에 내 컴퓨터와 다른 컴퓨터 혹은 또다른 스위치나 라우터 등이 연결되어 있을 때 이들이 LAN에 포함된다.

### WAN

자신이 포함되지 않은 외부 네트워크 구간을 의미한다. 이는 주로 라우터를 통해 연결된다.



### 공인 아이피

공인 아이피란 실제 인터넷 환경에서 기기를 구별할 수 있는 IP 주소이다.

### 사설 아이피

사설 아이피란 내부 네트워크 상에서만 유효한 IP 주소다. 이는 공인 아이피의 양이 모든 기기에 부여할 만큼 넉넉하지 않기 때문이다.

사설 ip의 대역은 아래와 같다.
10.0.0.0 ~ 10.255.255.255
172.16.0.0 ~ 172.31.255.255
192.168.0.0 ~ 192.168.255.255



### IP 클래스

기업, 기관, 단체 등에서 많은 IP를 유연하게 관리기위해 IP에 클래스를 나눠놨다.

클래스를 나누기위해 IP는 네트워크 주소와 호스트 주소로 나뉜다.

앞에서 몇비트는 네트워크를 나누는 네트워크 주소와 뒤의 나머지 비트는 기기를 나누는 호스트 주소로 나뉜다.

한 단체에게 네트워크 주소를 할당해 주면 단체에서 호스트 주소를 각 기계에게 나눠주어 관리할 수 있다.

클래스에는 A, B, C, D, E 클래스가 있으며 주로 일반적으로 A, B, C 클래스가 사용된다.
각 클래스마다 네트워크 주소의 크기와 시작 비트가 다르다.

| 클래스   | 네트워크 주소 크기 | 시작 비트 |
| -------- | ------------------ | --------- |
| A 클래스 | 1Byte              | 0         |
| B 클래스 | 2Byte              | 10        |
| C 클래스 | 3Byte              | 110       |

*218.149.52.177* 이 ip 주소를 예시로 보자
일단 이를 비트로 변환하자

| 1         | 2         | 3         | 4         |
| --------- | --------- | --------- | --------- |
| 1101 1010 | 1001 0101‬ | 0011 0100‬ | 1011 0001‬ |

우선 110으로 시작한다. 그럼 C 클래스임을 알 수가 있다.
그리고 C 클래스는 3Byte를 네트워크 주소로 사용한다.

네트워크 주소의 크기에 따라 호스트 주소의 크기가 달라진다.
따라서 학교나 정부 기관 같은 많은 양의 기기를 가지는 곳은 A, B 클래스를 가정에는 C 클래스를 공급할 수 있다.

A 클래스는 2^24개로 16,777,216개

B 클래스는 2^16개로 65,536‬개

C 클래스는 2^8개로 256개

단 저 만큼의 호스트를 모두 사용할 수 없다.
이는 몇몇 아이피는 특수한 목적을 위해 빼놨기 때문이다. (브로드캐스트 등)



### 서브넷 마스크

이렇게 클래스를 나눠놨는데 문제는 C 클래스와 B 클래스 사이에 격차가 너무 크다는 거다.
C를 사용하기엔 너무 적고 B를 사용하기엔 너무 많다. 그냥 B 클래스를 사용하기에는 IP 주소가 낭비되기 때문이다.

그래서 나온 것이 네트워크를 다시 서브넷들로 나누는 것이다.
이를 가능하게 하는 것이 서브넷 마스크다.
IP주소에 마스크 연산을 취해 네트워크 주소를 늘릴 수 있다.

다시 128.149.52.177 주소를 보자

| 1        |          | 2        |          | 3        |          | 4      |        |
| -------- | -------- | -------- | -------- | -------- | -------- | ------ | ------ |
| 1101     | 1010     | 1001     | 0101‬     | 0011     | 0100‬     | 1011   | 0001‬   |
| 네트워크 | 네트워크 | 네트워크 | 네트워크 | 네트워크 | 네트워크 | 호스트 | 호스트 |

여기서 우리는 4비트만 호스트 주소로 사용하고 싶다면 아래와 같은 마스크 비트를 사용할 수 있다.

| 1    |      | 2    |      | 3    |      | 4    |      |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 1101 | 1010 | 1001 | 0101‬ | 0011 | 0100‬ | 1011 | 0001‬ |
| 1111 | 1111 | 1111 | 1111 | 1111 | 1111 | 1111 | 0000 |

이후 마스크 작업을 하고나면 128.149.52.176이라는 서브넷 네트워크 주소가 나온다.
그럼 이젠 뒤의 4비트만 호스트 주소로 사용할 수 있다.
이런식으로 서브넷 마스크와 함께 ip를 분배하면 우리는 보다 원하는 사용량만 사용할 수 있다.

그리고 서브넷 마스크는 각 클래스의 네트워크 주소 크기 만큼은 앞에서부터 1로 채워야한다.

즉 A 클래스는 1byte가 네트워크 주소 크기이므로 서브넷 마스크는 최소 255.0.0.0이 되어야 한다.
그래야 네트워크 주소의 크기가 더 작아지지 않기 때문이다.



### NAT

NAT은 내부 네트워크에 존재하는 기기의 내부아이피를 외부 아이피로 바꾸는 기능을 말한다. 이는보통 방화벽에 존재하는 기능이다. 
이 덕분에 외부 네트워크에 존재하는 기기와 내부 네트워크에 존재하는 기기와 네트워킹이 가능해진다.

NAT의 기능을 세분화 한다면 연결과 보안으로 나눌 수 있다.
연결은 위에서 설명했 듯 내부 아이피와 외부 아이피를 연결하고 또한 내부 포트와 외부 포트를 연결할 수 있다.
보안은 특정한 아이피를 막거나 특정한 포트를 막는 것이다.
우리가 네트워크 개발을 하면 이 때문에 문제를 격는 경우가 많은데 아이피는 보통 다 열려있지만 포트는 다 막혀있다.
포트를 여는 방법은 내부에서 외부로 나가면서 열거나 특정 포트만 열리도록 따로 설정한 경우다.

NAT의 기능을 알아보기 위해 예시를 들어보겠다.
상황은 우리의 컴퓨터(윈도우 운영체제다)는 라우터의 내부 네트워크에 위치해 사설 아이피를 가지고 라우터는 공인 아이피를 가졌다.
여기서 알아야 할 점은 NAT은 보편적인 상황에서는 우리의 컴퓨터 운영체제(운영체제 방화벽)와 라우터에 있다.

우리가 컴퓨터에서 웹서버를 열 것이다.

이때 웹서버의 IP를 localhost(127.0.0.1)로 bind했고 포트는 80번을 사용한다.
그럼 우리의 컴퓨터 운영체제의 NAT은 아무런 일도 하지 않는다. 그 이유는 localhost는 외부와 연결하는 것이 아닌 내부(우리의 컴퓨터)에서만 유효한 IP이기 때문이다.

이제 우리는 cmd에서 ipconfig라는 명령어를 통해 하나의 IP 주소를 얻었다.(사설 IP다) 이를 통해 다시 웹서버를 bind 했다. 이때 운영체제의 NAT은 localhost의 ip를 사설 ip로 바꾸는 일을 하게 될 것이다. 하지만 여전히 외부에서 접속할 수 없다. 심지어 같은 네트워크에 존재한 컴퓨터들 까지도 말이다.
그 이유는 NAT이 80번 포트를 아직 열지 않기 때문이다.

우~리는 운영체제의 방화벽에서 80번 포트를 열도록 다시 설정해줬다. 하지만 여전히 외부에서 접속하지 못하는 것은 매한가지다. 하지만 달라진 점이 있다면 같은 내부 네트워크에 존재하는 컴퓨터들은 접속이 가능해졌다는 것이다. 그 이유는 내부 아이피(사설 아이피)로 bind 했기 때문에 라우터의 NAT은 내부에서만 사용되는 것으로 인지하고 아무런 동작하지 않는다.

그래서 우리는 공인 아이피를 알아낸 다음(네이버에 내 아이피 라고 쳐도 나온다.)에 bind 시켰다. 오우 아직도 외부에서 접속이 불가능하다. 라우터의 NAT은 사설 아이피와 외부 아이피를 연결 시켰을 지는 몰라도 포트를 열지 않았다. 그래서 우리는 다시 포트를 열러 갔다.

다행이도 이번에는 외부에서도 잘 접속할 수 있었다.



### 포트 포워딩

NAT을 이용해 외부에서 접속을 할려면 포트를 열어야 한다는 것을 알게 되었다. 이렇게 여는 작업을 포트 포워딩이라고 한다.

그럼 'TCP를 이용하든 UDP를 이용하든 포트를 사용하는데 사용자인 입장에서는 왜 포트 포워딩 같은 작업이 필요가 없을까?' 라는 의문이 들 수 있다.

이는 NAT이 내부에서 외부로 나갈 때 포트를 자동으로 열어주기 때문이다.
그래서 우리가 사용자인 입장에서는 보통 서버로 접속을 하는 입장이니 직접 포트 포워딩과 같은 일을 안해도 된다.

단 생각할 수 있는 문제점이 있는데 P2P와 같은 양쪽 모두 사용자인 상황이다. 특히 TCP와 달리 서버와 클라이언트가 분명하게 구별되지 않는 UDP의 경우 누가 먼저 접근할 지도 모르며 누가 내부 네트워크에 있어 접근을 막아버릴 지도 모른다. 특히 양쪽 모두 내부 내트워크에 있다면 완전히 방법이 없는 것 처럼 보인다.
이때 사용하는 방법이 홀 펀칭이라는 기법이다.

하나의 서버를 둔다. 그럼 클라이언트들은 이 서버에 접속한 후 서버로 부터 다른 클라이언트의 아이피와 포트를 받아내면 된다. 그럼 서버에 접속을 하느라 포트를 열게 되고 거기를 통해 다른 클라이언트가 접근하게 되는 것이다. 
단 이런 방식의 경우 시간이 어느 정도가 지나도록 통신이 없다면 자동으로 포트가 닫힐 수 있으므로 지속적으로 자신이 존재함을 알려주는 패킷을 보내줘야 한다.





## 문제

친구에게 편지를 보낸다고 생각할 때, 우리는 편지봉투에 주소를 기입한다. 그럼 정확하게 친구집으로 배달된다. 

클라이언트가 서버에게 데이터를 보내기 위해서도 주소를 사용한다. 다들 학교 노트북에 세팅해본적 있을 것이다. IP주소! 

그렇다면, 당신의 주소(10.157.X.X)를 친구에게 알려주면 당신의 PC로 데이터를 보낼 수 있지 않을까?? 정말 그런가?? 그렇지않다면, 왜 그런가? 

원격에 있는 내 PC로 접속할 수 있는 방법에 대해 생각해보자. 



### 답

불가능하다.
그 이유는 일단 10.157.X.X는 사설 아이피에 해당한다. 따라서 우선 공인 아이피를 알려줘야 한다. 그리고 내가 사용할 포트를 우선 운영체제의 NAT에서 열어야 한다. 그리고 학교의 라우터의 NAT에서 포트를 또 열어야 한다. 그럼 친구는 접속이 가능할 것이다. 그런데 학교의 라우터의 NAT에서 포트를 여는 것은 불가능할 가능성이 높다. 특히 고작 친구의 메세지를 받기 위해서라면 말이다. 그래서 홀 펀칭 기법을 사용하는 것이 현실적이다. 물론 외부에 작은 서버를 하나 두어야 하지만 말이다.